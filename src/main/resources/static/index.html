<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced To-Do App</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        .container { display: flex; gap: 20px; }
        .column { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
        h1, h2 { text-align: center; }
        ul { list-style: none; padding: 0; }
        li { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        li:hover { background-color: #f0f0f0; }
        form { margin-bottom: 15px; display: flex; }
        form input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; }
        form button { margin-left: 10px; padding: 8px 12px; }
        .delete-btn { background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .active-task { background-color: #e0e0ff; font-weight: bold; }
    </style>
</head>
<body>

<h1>Advanced To-Do App</h1>

<div class="container">
    <div class="column">
        <h2>Tasks</h2>
        <form id="task-form">
            <input type="text" id="task-input" placeholder="Enter a new task..." required>
            <button type="submit">Add Task</button>
        </form>
        <ul id="task-list">
        </ul>
    </div>

    <div class="column" id="subitem-column" style="display: none;">
        <h2 id="subitem-header">Sub-items for Task: </h2>
        <form id="subitem-form">
            <input type="hidden" id="task-id-hidden">
            <input type="text" id="subitem-input" placeholder="Enter a new sub-item..." required>
            <button type="submit">Add Sub-item</button>
        </form>
        <ul id="subitem-list">
        </ul>
    </div>
</div>

<script>
    const taskList = document.getElementById('task-list');
    const taskForm = document.getElementById('task-form');
    const taskInput = document.getElementById('task-input');

    const subitemColumn = document.getElementById('subitem-column');
    const subitemHeader = document.getElementById('subitem-header');
    const subitemForm = document.getElementById('subitem-form');
    const subitemInput = document.getElementById('subitem-input');
    const subitemList = document.getElementById('subitem-list');
    const taskIdHidden = document.getElementById('task-id-hidden');

    let selectedTaskId = null;

    // Function to fetch and display all tasks
    async function fetchTasks() {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();

        taskList.innerHTML = '';
        tasks.forEach(task => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${task.description}</span><button class="delete-btn" data-id="${task.id}">Delete</button>`;
            li.dataset.id = task.id;
            li.addEventListener('click', () => selectTask(task));
            taskList.appendChild(li);
        });
    }

    // Function to select a task and display its sub-items
    function selectTask(task) {
        selectedTaskId = task.id;
        subitemHeader.textContent = `Sub-items for Task: ${task.description}`;
        taskIdHidden.value = task.id;
        subitemColumn.style.display = 'block';

        // Highlight the selected task
        document.querySelectorAll('#task-list li').forEach(item => {
            item.classList.remove('active-task');
            if (item.dataset.id == task.id) {
                item.classList.add('active-task');
            }
        });

        displaySubItems(task.taskItems);
    }

    // Function to display sub-items for the selected task
    function displaySubItems(subItems) {
        subitemList.innerHTML = '';
        subItems.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${item.description}</span><button class="delete-btn" data-id="${item.id}">Delete</button>`;
            subitemList.appendChild(li);
        });
    }

    // Event listener for adding a new task
    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const description = taskInput.value;
        await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description: description })
        });
        taskInput.value = '';
        await fetchTasks();
    });

    // Event listener for deleting a task
    taskList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-btn')) {
            e.stopPropagation(); // Prevent selecting the task when deleting
            const taskId = e.target.dataset.id;
            await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
            await fetchTasks();
            // If the deleted task was the selected one, hide subitem column
            if (taskId == selectedTaskId) {
                subitemColumn.style.display = 'none';
                selectedTaskId = null;
            }
        }
    });

    // Event listener for adding a new sub-item
    subitemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const taskId = taskIdHidden.value;
        const description = subitemInput.value;
        await fetch(`/api/tasks/${taskId}/items`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description: description })
        });
        subitemInput.value = '';
        await fetchTasksAndSelectTask(taskId);
    });

    // Event listener for deleting a sub-item
    subitemList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-btn')) {
            const itemId = e.target.dataset.id;
            await fetch(`/api/tasks/items/${itemId}`, { method: 'DELETE' });
            await fetchTasksAndSelectTask(selectedTaskId);
        }
    });

    // Helper function to re-fetch all tasks and re-select the current one
    async function fetchTasksAndSelectTask(taskId) {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        const task = tasks.find(t => t.id == taskId);
        if (task) {
            selectTask(task);
        }
    }

    // Initial fetch on page load
    document.addEventListener('DOMContentLoaded', fetchTasks);
</script>

</body>
</html>