<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>To-Do App</title>
    <style>
       <link rel="stylesheet" href="/style.css">
    </style>
</head>
<body>

<h1>To-Do App</h1>

<div class="container">
    <div class="column">
        <h2>Tasks</h2>
        <form id="task-form">
            <input type="text" id="task-input" placeholder="Enter a new task..." required>
            <button type="submit">Add Task</button>
        </form>
        <ul id="task-list">
        </ul>
    </div>

    <div class="column" id="subitem-column" style="display: none;">
        <h2 id="subitem-header">Sub-items for Task: </h2>
        <form id="subitem-form">
            <input type="hidden" id="task-id-hidden">
            <input type="text" id="subitem-input" placeholder="Enter a new sub-item..." required>
            <button type="submit">Add Sub-item</button>
        </form>
        <ul id="subitem-list">
        </ul>
    </div>
</div>

<script>
    const taskList = document.getElementById('task-list');
    const taskForm = document.getElementById('task-form');
    const taskInput = document.getElementById('task-input');

    const subitemColumn = document.getElementById('subitem-column');
    const subitemHeader = document.getElementById('subitem-header');
    const subitemForm = document.getElementById('subitem-form');
    const subitemInput = document.getElementById('subitem-input');
    const subitemList = document.getElementById('subitem-list');
    const taskIdHidden = document.getElementById('task-id-hidden');

    let selectedTaskId = null;

    async function fetchTasks() {
        // Wymuszenie pobrania świeżych danych
        const response = await fetch('/api/tasks', { cache: 'no-store' });
        const tasks = await response.json();

        taskList.innerHTML = '';
        tasks.forEach(task => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${task.description}</span>
                            <div class="task-actions">
                                <button class="edit-btn" data-id="${task.id}" data-type="task">Edit</button>
                                <button class="delete-btn" data-id="${task.id}" data-type="task">Delete</button>
                            </div>`;
            li.dataset.id = task.id;
            li.addEventListener('click', () => selectTask(task));
            taskList.appendChild(li);
        });
    }

    function selectTask(task) {
        selectedTaskId = task.id;
        subitemHeader.textContent = `Sub-items for Task: ${task.description}`;
        taskIdHidden.value = task.id;
        subitemColumn.style.display = 'block';

        document.querySelectorAll('#task-list li').forEach(item => {
            item.classList.remove('active-task');
            if (item.dataset.id == task.id) {
                item.classList.add('active-task');
            }
        });

        displaySubItems(task.taskItems);
    }

    function displaySubItems(subItems) {
        subitemList.innerHTML = '';
        subItems.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${item.description}</span>
                            <div class="task-actions">
                                <button class="edit-btn" data-id="${item.id}" data-type="subitem">Edit</button>
                                <button class="delete-btn" data-id="${item.id}" data-type="subitem">Delete</button>
                            </div>`;
            subitemList.appendChild(li);
        });
    }

    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const description = taskInput.value;
        await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description: description })
        });
        taskInput.value = '';
        await fetchTasks();
    });

    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const type = btn.dataset.type;
        const id = btn.dataset.id;

        // DELETE
        if (btn.classList.contains('delete-btn')) {
            e.stopPropagation();
            try {
                let res;
                if (type === 'task') {
                    res = await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                    console.log('DELETE task', id, res.status);
                    if (!res.ok) throw new Error(`Task delete failed: ${res.status}`);
                    await fetchTasks();
                    if (id == selectedTaskId) {
                        subitemColumn.style.display = 'none';
                        selectedTaskId = null;
                    }
                } else if (type === 'subitem') {
                    res = await fetch(`/api/tasks/items/${id}`, { method: 'DELETE' });
                    console.log('DELETE subitem', id, res.status);
                    if (!res.ok) throw new Error(`Subitem delete failed: ${res.status}`);

                    // Natychmiast usuń element z DOM
                    btn.closest('li').remove();

                    // Dociągnij świeże dane (na wszelki wypadek)
                    await fetchTasksAndSelectTask(selectedTaskId);
                }
            } catch (err) {
                console.error(err);
                alert('Delete failed. Check console/network tab.');
            }
        }

        // EDIT
        else if (btn.classList.contains('edit-btn')) {
            e.stopPropagation();
            const li = btn.closest('li');
            const span = li.querySelector('span');
            const currentDescription = span.textContent;

            li.innerHTML = `<input type="text" class="edit-input" value="${currentDescription}" required>
                            <div class="task-actions">
                                <button type="button" class="save-btn" data-id="${id}" data-type="${type}">Save</button>
                                <button type="button" class="cancel-btn">Cancel</button>
                            </div>`;

            const saveBtn = li.querySelector('.save-btn');
            const cancelBtn = li.querySelector('.cancel-btn');

            saveBtn.addEventListener('click', async (e) => {
                 e.preventDefault();
                 const newDescription = li.querySelector('.edit-input').value;
                 if (type === 'task') {
                     await fetch(`/api/tasks/${id}`, {
                         method: 'PUT',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ description: newDescription })
                     });
                     await fetchTasks();
                 } else if (type === 'subitem') {
                     await fetch(`/api/tasks/items/${id}`, {
                         method: 'PUT',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ description: newDescription })
                     });
                     await fetchTasksAndSelectTask(selectedTaskId);
                 }
             });

            cancelBtn.addEventListener('click', async (e) => {
                 e.preventDefault();
                 if (type === 'task') {
                     await fetchTasks();
                 } else if (type === 'subitem') {
                     await fetchTasksAndSelectTask(selectedTaskId);
                 }
            });
        }
    });

    subitemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const taskId = taskIdHidden.value;
        const description = subitemInput.value;
        await fetch(`/api/tasks/${taskId}/item`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description: description })
        });
        subitemInput.value = '';
        await fetchTasksAndSelectTask(taskId);
    });

    async function fetchTasksAndSelectTask(taskId) {
        // Wymuszenie pobrania świeżych danych
        const response = await fetch('/api/tasks', { cache: 'no-store' });
        const tasks = await response.json();
        const task = tasks.find(t => t.id == taskId);
        if (task) {
           selectTask(task);
        } else {
           subitemColumn.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', fetchTasks);
</script>

</body>
</html>